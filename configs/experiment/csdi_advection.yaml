# CSDI on 2D linear advection
#
# Usage:
#   python scripts/run_experiment.py --model csdi --config configs/experiment/csdi_advection.yaml
#
# The advection data has shape (3475, 64, 64).  Subsampling parameters below
# control what the model actually sees — nothing is hard-coded.

# --- Data loading ---------------------------------------------------------
data:
  type: advection                        # triggers the advection loader
  path: datasets/synthetic/advection_data_2d.npy

  # Spatial subsampling: stride along x and y axes
  #   1 → 64×64 = 4096 features  (full resolution, very heavy)
  #   2 → 32×32 = 1024 features
  #   4 → 16×16 = 256  features
  #   8 →  8×8  = 64   features  (reasonable for CSDI attention)
  spatial_stride: 8

  # Temporal subsampling: keep every n-th timestep
  temporal_stride: 1

  # Sliding window
  window_size: 64                       # L — timesteps per sample
  window_stride: 8                      # step between windows

  normalise: true

  # Masking (how the model sees the data during training/eval)
  miss_ratio: 0.1
  mask_strategy: random                 # "random" | "future"

# --- Dimensions (derived from subsampling above) --------------------------
# target_dim is set automatically from the data, but can be overridden:
# target_dim: 64   # = (64/8)^2 with spatial_stride=8
seq_len: 64         # must equal window_size

batch_size: 32

# --- CSDI model config ----------------------------------------------------
csdi:
  diffusion:
    layers: 4
    channels: 64
    nheads: 8
    num_steps: 50
    schedule: quad
    beta_start: 0.0001
    beta_end: 0.5
    diffusion_embedding_dim: 128
  model:
    is_unconditional: false
    timeemb: 128
    featureemb: 16
    target_strategy: random

# --- Training -------------------------------------------------------------
training:
  epochs: 100
  lr: 0.001
  patience: 15
  save_dir: results/checkpoints/csdi_advection

# --- Evaluation -----------------------------------------------------------
evaluation:
  n_samples: 10
  save_dir: results/metrics/csdi_advection

# --- Diagnostics ----------------------------------------------------------
diagnostics:
  semigroup:
    t1: 16
    t2: 16
  conservation: true
  horizon:
    horizons: [8, 16, 32, 48]
    context_len: 16
  sparsity:
    miss_ratios: [0.1, 0.2, 0.3, 0.5, 0.7]
  wasserstein:
    n_projections: 128
